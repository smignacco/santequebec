generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}






model OrganizationType {
  id        String         @id @default(cuid())
  code      String         @unique
  label     String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  organizations Organization[]
}

model Organization {
  id                 String           @id @default(cuid())
  orgCode            String           @unique
  regionCode         String
  displayName        String
  supportContactEmail String?
  reminderNotificationsEnabled Boolean @default(true)
  welcomeVideoDismissed Boolean        @default(false)
  isDrill            Boolean          @default(false)
  isActive           Boolean          @default(true)
  organizationTypeId String
  organizationType   OrganizationType @relation(fields: [organizationTypeId], references: [id])
  access             OrgAccess[]
  inventoryFiles     InventoryFile[]
  reminderRequests   ReminderApproval[]
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}

model AppSettings {
  id                  String   @id
  welcomeVideoUrl     String?
  webexEnabled        Boolean  @default(false)
  webexBotToken       String?
  webexRoomId         String?
  webexNotifyOnSubmit Boolean  @default(true)
  webexNotifyOnHelp   Boolean  @default(true)
  webexNotifyOnLogin  Boolean  @default(false)
  webexNotifyOnReminder Boolean @default(true)
  reminderEmailEnabled Boolean @default(true)
  reminderBusinessDays Int @default(5)
  reminderEmailSubjectTemplate String?
  reminderEmailTextTemplate String?
  reminderEmailHtmlTemplate String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Batch {
  id        String      @id @default(cuid())
  name      String
  status    String @default("DRAFT")
  access    OrgAccess[]
  inventoryFiles InventoryFile[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model OrgAccess {
  id             String       @id @default(cuid())
  organizationId String
  batchId        String
  pinHash        String
  isEnabled      Boolean      @default(true)
  expiresAt      DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id])
  batch          Batch        @relation(fields: [batchId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, batchId])
}

model InventoryFile {
  id             String              @id @default(cuid())
  batchId        String
  organizationId String
  sourceFilename String
  sourceChecksum String
  importedAt     DateTime            @default(now())
  rowCount       Int
  publishedColumns String?
  status         String @default("NOT_SUBMITTED")
  isLocked       Boolean @default(false)
  batch          Batch               @relation(fields: [batchId], references: [id])
  organization   Organization        @relation(fields: [organizationId], references: [id])
  items          InventoryItem[]
  reminderRequests ReminderApproval[]
}

model ReminderApproval {
  id                String        @id @default(cuid())
  organizationId    String
  inventoryFileId   String
  loginAuditLogId   String
  recipientEmail    String
  remainingCount    Int
  totalCount        Int
  status            String        @default("PENDING_APPROVAL")
  requestedAt       DateTime      @default(now())
  approvedAt        DateTime?
  approvedByName    String?
  approvedByEmail   String?
  rejectedAt        DateTime?
  rejectedByName    String?
  rejectedByEmail   String?
  rejectionReason   String?
  sentAt            DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  organization      Organization  @relation(fields: [organizationId], references: [id])
  inventoryFile     InventoryFile @relation(fields: [inventoryFileId], references: [id])

  @@index([organizationId, status])
  @@index([status, requestedAt])
  @@unique([inventoryFileId, loginAuditLogId])
}

model InventoryItem {
  id              String              @id @default(cuid())
  inventoryFileId String
  rowNumber       Int
  assetTag        String?
  serial          String?
  model           String?
  site            String?
  location        String?
  notes           String?
  instanceNumber  String?
  serialNumber    String?
  productId       String?
  productDescription String?
  major           String?
  productType     String?
  productFamily   String?
  architecture    String?
  subArchitecture String?
  quantity        String?
  ldos            String?
  ldosDetailsInMonths String?
  centreDeSanteRegional String?
  serviceableFlag String?
  contractNumber  String?
  serviceLevel    String?
  serviceLevelDescription String?
  serviceStartDate String?
  serviceEndDate  String?
  globalServiceList String?
  excludedAsset   String?
  status          String @default("PENDING")
  manualEntry     Boolean @default(false)
  updatedAt       DateTime            @updatedAt
  inventoryFile   InventoryFile       @relation(fields: [inventoryFileId], references: [id])
}

model AuditLog {
  id         String     @id @default(cuid())
  scope      String
  scopeId    String
  actorType  String
  actorName  String
  actorEmail String
  action     String
  detailsJson String
  createdAt  DateTime   @default(now())
}

model AdminUser {
  id           String   @id @default(cuid())
  username     String   @unique
  email        String   @unique
  displayName  String
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
